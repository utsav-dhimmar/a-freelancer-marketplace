<div class="container mt-4">
  @if (loading()) {
    <div class="text-center py-5">
      <div class="spinner-border" role="status"></div>
    </div>
  } @else if (job()) {
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <h2>{{ job()!.title }}</h2>
          <span class="badge bg-info">{{ job()!.status }}</span>
        </div>

        <div class="mb-3">
          <span class="badge bg-success fs-6">\${{ job()!.budget }} {{ job()!.budgetType }}</span>
          <span class="badge bg-secondary ms-2">{{ job()!.difficulty }}</span>
        </div>

        <h5>Description</h5>
        <p>{{ job()!.description }}</p>

        <h5>Required Skills</h5>
        <div class="mb-3">
          @for (skill of job()!.skillsRequired; track skill) {
            <span class="badge bg-secondary me-1">{{ skill }}</span>
          }
        </div>

        <div class="text-muted small mb-4">Posted: {{ job()!.createdAt | date: 'medium' }}</div>

        @if (isFreelancer() && job()!.status === 'open') {
          <button class="btn btn-primary" (click)="showProposalForm = true">Submit Proposal</button>
        }

        @if (showProposalForm) {
          <div class="card mt-3">
            <div class="card-body">
              <h5>Submit Proposal</h5>
              <form [formGroup]="proposalForm" (ngSubmit)="submitProposal()">
                <div class="mb-3">
                  <label class="form-label">Cover Letter</label>
                  <textarea
                    class="form-control"
                    [class.is-invalid]="isFieldInvalid('coverLetter')"
                    formControlName="coverLetter"
                    rows="4"
                    placeholder="Describe why you're a good fit for this job..."
                  ></textarea>
                  <div class="invalid-feedback">
                    @if (proposalForm.get('coverLetter')?.errors?.['required']) {
                      Cover letter is required.
                    } @else if (proposalForm.get('coverLetter')?.errors?.['minlength']) {
                      Cover letter must be at least 50 characters long.
                    }
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Bid Amount ($)</label>
                  <input
                    type="number"
                    class="form-control"
                    [class.is-invalid]="isFieldInvalid('bidAmount')"
                    formControlName="bidAmount"
                  />
                  <div class="invalid-feedback">
                    @if (proposalForm.get('bidAmount')?.errors?.['required']) {
                      Bid amount is required.
                    } @else if (proposalForm.get('bidAmount')?.errors?.['min']) {
                      Bid amount must be at least $1.
                    }
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Estimated Time</label>
                  <input
                    type="text"
                    class="form-control"
                    [class.is-invalid]="isFieldInvalid('estimatedTime')"
                    formControlName="estimatedTime"
                    placeholder="e.g., 2 weeks"
                  />
                  <div class="invalid-feedback">Estimated time is required.</div>
                </div>
                <button
                  type="submit"
                  class="btn btn-success me-2"
                  [disabled]="submittingProposal()"
                >
                  {{ submittingProposal() ? 'Submitting...' : 'Submit' }}
                </button>
                <button type="button" class="btn btn-secondary" (click)="showProposalForm = false">
                  Cancel
                </button>
              </form>
            </div>
          </div>
        }
      </div>
    </div>

    @if (isClient() && isOwner()) {
      <div class="card mt-4">
        <div class="card-body">
          <h5>Proposals</h5>
          <a [routerLink]="['/jobs', job()!._id, 'proposals']" class="btn btn-outline-primary"
            >View Proposals</a
          >
        </div>
      </div>
    }
  } @else {
    <div class="alert alert-danger">Job not found</div>
  }
  <a routerLink="/jobs" class="btn btn-link mt-3">Back to Jobs</a>
</div>
